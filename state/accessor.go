package state

// Accessor is a struct that provides access to the state.
type Accessor[T Model] struct {
	model     T
	observers []Observer[T]
}

// NewAccessor creates a new Accessor for the provided model.
func NewAccessor[T Model](model T) *Accessor[T] {
	return &Accessor[T]{
		model:     model,
		observers: make([]Observer[T], 0),
	}
}

// RegisterObserver adds an observer to the list of observers that will be notified when the model changes.
func (a *Accessor[T]) RegisterObserver(observer Observer[T]) {
	a.observers = append(a.observers, observer)
}

// Query returns a copy of the model, so that all changes to the model are isolated and forced through the Update method in order to notify observers.
func (a *Accessor[T]) Query() T {
	return a.model.Clone().(T)
}

// Update modifies the model using the provided modifier function and notifies all observers of the change.
func (a *Accessor[T]) Update(modifier func(T) error) error {
	before := a.model.Clone().(T)
	if err := modifier(a.model); err != nil {
		return err
	}
	after := a.model.Clone().(T)

	a.notifyObservers(after, before)
	return nil
}

func (a *Accessor[T]) notifyObservers(new, old T) {
	for _, observer := range a.observers {
		observer.Update(new, old)
	}
}
